<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™êµ ì‹ë‹¨í‘œ (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #F8F9FA; /* Neutral Light */
            color: #343A40; /* Neutral Dark */
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .table-header {
            background-color: #007BFF; /* Primary Blue */
            color: white;
            font-weight: 600;
            padding: 0.75rem 1rem;
            text-align: center;
        }
        .table-cell {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #E0E0E0; /* Light Gray Border */
            text-align: center;
        }
        .table-row:nth-child(even) {
            background-color: #F0F8FF; /* Lightest Blue */
        }
        .table-row:hover {
            background-color: #E0F2FE; /* Slightly darker light blue on hover */
            /* cursor: pointer; */ /* í•™ìƒ í–‰ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ë³€ê²½ë˜ë¯€ë¡œ, ì „ì²´ í–‰ hover íš¨ê³¼ëŠ” ì œê±°í•˜ê±°ë‚˜ ìœ ì§€ */
        }
        .table-row.selected {
            background-color: #ADD8E6 !important; /* Light Blue for selection, !important to override nth-child */
            font-weight: 500;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #007BFF; /* Primary Blue */
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3; /* Darker Blue on hover */
        }
        .btn-tertiary {
            background-color: #28A745; /* Green for new action */
            color: white;
        }
        .btn-tertiary:hover {
            background-color: #218838; /* Darker Green on hover */
        }
        .message-box {
            background-color: #E0F2FE;
            border: 1px solid #007BFF;
            color: #073B4C;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1rem;
            white-space: pre-wrap; 
            word-break: break-word; 
        }
        .menu-input-group input, .menu-input-group select {
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            font-size: 1rem;
            width: 100%;
        }
        .menu-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .summary-table-container {
            margin-top: 2rem;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.05);
        }
        .summary-table th, .summary-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #E0E0E0;
        }
        .summary-table thead {
            background-color: #5CACEE; /* Secondary Blue */
            color: white;
        }
        .summary-table tbody tr:nth-child(even) {
            background-color: #F0F8FF;
        }
        .admin-section.locked .menu-input-group input:not(#adminPassword),
        .admin-section.locked #setTodayMenusBtn {
            pointer-events: none;
            opacity: 0.6;
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        .loader {
            border: 5px solid #f3f3f3; /* Light grey */
            border-top: 5px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-2xl font-bold text-center mb-6 text-[#073B4C]" id="mainTitle">ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</h1>
        <p class="mb-4 text-center text-gray-700">
            í•™ìƒë“¤ì˜ ë©”ë‰´ ì„ íƒì„ ê¸°ë¡í•˜ê³  í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ë‚ ì§œì™€ ì‹ì‚¬ ì‹œê°„ëŒ€ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.
        </p>

        <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
            <div class="flex items-center space-x-2">
                <label for="menuDate" class="font-bold text-lg">ë‚ ì§œ:</label>
                <input type="date" id="menuDate" class="p-2 border rounded text-lg">
            </div>
            <div class="flex items-center space-x-2">
                <label for="mealType" class="font-bold text-lg">ì‹ì‚¬:</label>
                <select id="mealType" class="p-2 border rounded text-lg">
                    <option value="breakfast">ì•„ì¹¨</option>
                    <option value="lunch" selected>ì ì‹¬</option>
                    <option value="dinner">ì €ë…</option>
                </select>
            </div>
        </div>

        <div class="mt-8 mb-6 admin-section locked">
            <h2 class="text-xl font-bold text-center mb-4 text-[#073B4C]">ë©”ë‰´ ê´€ë¦¬ì</h2>
            <div class="flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                <input type="password" id="adminPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" class="p-2 border rounded w-full sm:w-48">
                <button id="adminLoginBtn" class="btn btn-primary w-full sm:w-auto">ë©”ë‰´ ê´€ë¦¬ì ë¡œê·¸ì¸</button>
            </div>
            
            <div id="adminMenuInput" class="menu-input-group">
                <p class="text-center text-gray-700">
                    ì•„ë˜ì— ì„ íƒëœ ë‚ ì§œì™€ ì‹ì‚¬ ì‹œê°„ëŒ€ì— ì œê³µë  ë©”ë‰´ 4ê°€ì§€ë¥¼ ì…ë ¥í•˜ê³ , 'ë©”ë‰´ ì„¤ì •' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
                </p>
                <input type="text" id="menuInput1" placeholder="ë©”ë‰´ 1 (ì˜ˆ: ëˆê¹ŒìŠ¤)">
                <input type="text" id="menuInput2" placeholder="ë©”ë‰´ 2 (ì˜ˆ: ê¹€ì¹˜ì°Œê°œ)">
                <input type="text" id="menuInput3" placeholder="ë©”ë‰´ 3 (ì˜ˆ: ë¶ˆê³ ê¸°ë®ë°¥)">
                <input type="text" id="menuInput4" placeholder="ë©”ë‰´ 4 (ì˜ˆ: ë‹­ê°ˆë¹„)">
                <div class="flex justify-center">
                    <button id="setTodayMenusBtn" class="btn btn-tertiary">ë©”ë‰´ ì„¤ì • ğŸ“</button>
                </div>
            </div>
        </div>
        
        <div id="loadingSpinner" class="loader hidden"></div>

        <div class="overflow-x-auto rounded-lg border border-gray-200 mb-6">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-[#007BFF]">
                    <tr>
                        <th scope="col" class="table-header rounded-tl-lg">ë²ˆí˜¸</th>
                        <th scope="col" class="table-header">í•™ë…„</th>
                        <th scope="col" class="table-header">ì´ë¦„</th>
                        <th scope="col" class="table-header rounded-tr-lg">ì„ íƒ ë©”ë‰´</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200" id="studentTableBody">
                    </tbody>
            </table>
        </div>
        
        <div id="menuSummaryTableContainer" class="summary-table-container hidden">
            <h2 class="text-xl font-bold text-center mb-4 text-[#073B4C]">ë©”ë‰´ë³„ ì„ íƒ í˜„í™©</h2>
            <table class="min-w-full summary-table divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th>ë©”ë‰´</th>
                        <th>ì„ íƒ í•™ìƒ ìˆ˜</th>
                    </tr>
                </thead>
                <tbody id="menuSummaryTableBody">
                    </tbody>
            </table>
        </div>

        <div id="messageBox" class="message-box">
            ë‚ ì§œì™€ ì‹ì‚¬ ì‹œê°„ëŒ€ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.
        </div>
        <p class="text-xs text-center text-gray-500 mt-4">Firebaseì™€ ì—°ë™ëœ í•™êµ ì‹ë‹¨í‘œì…ë‹ˆë‹¤.</p>
    </div>

    <script type="module">
        // Firebase SDK ê°€ì ¸ì˜¤ê¸° (ë²„ì „ì€ ìµœì‹ ìœ¼ë¡œ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, getDocs, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";


        // ğŸš¨ğŸš¨ğŸš¨ ì¤‘ìš”: ì—¬ê¸°ì— ë³¸ì¸ì˜ Firebase í”„ë¡œì íŠ¸ ì„¤ì • ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ğŸš¨ğŸš¨ğŸš¨
        // Firebase ì½˜ì†”ì—ì„œ ì›¹ ì•±ì„ ì¶”ê°€í•˜ê³  SDK ì„¤ì • ìŠ¤ë‹ˆí«ì„ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Firebase ì•± ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Canvas í™˜ê²½ìš© ì•± ID
        let userId = null; // í˜„ì¬ ì‚¬ìš©ì ID (ìµëª… ë¡œê·¸ì¸ ì‹œ)

        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const mainTitle = document.getElementById('mainTitle');
        const menuDateInput = document.getElementById('menuDate');
        const mealTypeSelect = document.getElementById('mealType');
        const studentTableBody = document.getElementById('studentTableBody');
        const adminSection = document.querySelector('.admin-section');
        const adminPasswordInput = document.getElementById('adminPassword');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const setTodayMenusBtn = document.getElementById('setTodayMenusBtn');
        const menuInputs = [
            document.getElementById('menuInput1'),
            document.getElementById('menuInput2'),
            document.getElementById('menuInput3'),
            document.getElementById('menuInput4')
        ];
        const messageBox = document.getElementById('messageBox');
        const menuSummaryTableContainer = document.getElementById('menuSummaryTableContainer');
        const menuSummaryTableBody = document.getElementById('menuSummaryTableBody');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ
        const ADMIN_PASSWORD = '8589'; // ğŸš¨ ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ë³´ì•ˆìƒ ì•ˆì „í•œ ì¸ì¦ ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
        let students = [ // í•™ìƒ ëª©ë¡ì€ í˜„ì¬ í”„ë¡ íŠ¸ì—”ë“œì— ìœ ì§€. í•„ìš”ì‹œ Firestoreì—ì„œ ê´€ë¦¬ ê°€ëŠ¥.
            { id: 1, grade: '1í•™ë…„', name: 'ê¹€ë¯¼ì¤€' }, { id: 2, grade: '2í•™ë…„', name: 'ì´ì„œìœ¤' },
            { id: 3, grade: '3í•™ë…„', name: 'ë°•ì§€í›„' }, { id: 4, grade: '1í•™ë…„', name: 'ìµœì˜ˆë‚˜' },
            { id: 5, grade: '4í•™ë…„', name: 'ì •í•˜ì¤€' }, { id: 6, grade: '5í•™ë…„', name: 'ê°•ì„œì•„' },
            { id: 7, grade: '6í•™ë…„', name: 'ì¡°ì€ìš°' }, { id: 8, grade: '1í•™ë…„', name: 'ìœ¤ë„í˜„' },
            { id: 9, grade: '2í•™ë…„', name: 'ì¥ìœ ì§„' }, { id: 10, grade: '3í•™ë…„', name: 'í•œì§€í›ˆ' },
            { id: 11, grade: '4í•™ë…„', name: 'ì˜¤ìˆ˜ì•„' }, { id: 12, grade: '5í•™ë…„', name: 'ê¹€ì¤€ì„œ' },
            { id: 13, grade: '6í•™ë…„', name: 'ì´í•˜ìœ¤' }, { id: 14, grade: '1í•™ë…„', name: 'ë°•ì„œì¤€' },
            { id: 15, grade: '2í•™ë…„', name: 'ìµœì•„ë¦°' }, { id: 16, grade: '3í•™ë…„', name: 'ì •ìš°ì§„' },
            { id: 17, grade: '4í•™ë…„', name: 'ê°•ì±„ì›' }, { id: 18, grade: '5í•™ë…„', name: 'ì¡°ì‹œìš°' },
            { id: 19, grade: '6í•™ë…„', name: 'ìœ¤ì§€ìš°' }, { id: 20, grade: '1í•™ë…„', name: 'ì¥ë„ìœ¤' },
            { id: 21, grade: '2í•™ë…„', name: 'í•œì„œí˜„' }, { id: 22, grade: '3í•™ë…„', name: 'ì˜¤ë¯¼ì¤€' },
            { id: 23, grade: '4í•™ë…„', name: 'ê¹€ê°€ì€' }, { id: 24, grade: '5í•™ë…„', name: 'ì´ì¤€ìš°' },
            { id: 25, grade: '6í•™ë…„', name: 'ë°•í•˜ì€' }, { id: 26, grade: '1í•™ë…„', name: 'ìµœì‹œí˜„' },
            { id: 27, grade: '2í•™ë…„', name: 'ì •ì†Œìœ¨' }, { id: 28, grade: '3í•™ë…„', name: 'ê°•ìŠ¹ë¯¼' },
        ];
        let currentMenus = []; // í˜„ì¬ ì„ íƒëœ ë‚ ì§œ/ì‹ì‚¬ ì‹œê°„ì˜ ë©”ë‰´ ëª©ë¡
        let studentSelections = {}; // í•™ìƒë“¤ì˜ ì„ íƒ ( studentId: selectedMenu )
        let selectedStudentRow = null; // í˜„ì¬ ì„ íƒëœ í…Œì´ë¸” í–‰
        let unsubscribeMenus = null; // ë©”ë‰´ ë¦¬ìŠ¤ë„ˆ
        let unsubscribeSelections = null; // ì„ íƒ í˜„í™© ë¦¬ìŠ¤ë„ˆ

        // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜
        function showLoading(show) {
            loadingSpinner.classList.toggle('hidden', !show);
        }
        
        // Firestore ë¬¸ì„œ ê²½ë¡œ ìƒì„± í•¨ìˆ˜
        function getMenuDocPath(date, mealType) {
            return `artifacts/${appId}/public/data/menus/${date}_${mealType}`;
        }

        function getStudentSelectionDocPath(date, mealType, studentId) {
             return `artifacts/${appId}/public/data/studentSelections/${date}_${mealType}_${studentId}`;
        }

        // í˜„ì¬ ë‚ ì§œì™€ ì‹ì‚¬ ì‹œê°„ì— ë§ëŠ” ë©”ë‰´ë¥¼ Firestoreì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        async function fetchMenus() {
            if (unsubscribeMenus) unsubscribeMenus(); // ì´ì „ ë¦¬ìŠ¤ë„ˆ í•´ì œ
            
            const date = menuDateInput.value;
            const mealType = mealTypeSelect.value;
            if (!date) return;

            showLoading(true);
            const menuDocRef = doc(db, getMenuDocPath(date, mealType));
            
            unsubscribeMenus = onSnapshot(menuDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentMenus = docSnap.data().items || [];
                    messageBox.innerHTML = `${currentMenus.length > 0 ? 'ë©”ë‰´ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì„¤ì •ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.'} í•™ìƒì„ í´ë¦­í•˜ì—¬ ë©”ë‰´ë¥¼ ì„ íƒí•˜ê±°ë‚˜, ê´€ë¦¬ì ì„¹ì…˜ì—ì„œ ë©”ë‰´ë¥¼ ì„¤ì •í•´ ì£¼ì„¸ìš”.`;
                } else {
                    currentMenus = [];
                    messageBox.innerHTML = 'ì„ íƒëœ ë‚ ì§œì™€ ì‹ì‚¬ ì‹œê°„ëŒ€ì— ì„¤ì •ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìê°€ ë©”ë‰´ë¥¼ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.';
                }
                renderStudentTable(); // ë©”ë‰´ ë³€ê²½ ì‹œ í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
                updateSummaryTable(); // ìš”ì•½ í…Œì´ë¸”ë„ ì—…ë°ì´íŠ¸
                showLoading(false);
            }, (error) => {
                console.error("Error fetching menus: ", error);
                messageBox.innerHTML = 'ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                currentMenus = [];
                renderStudentTable();
                updateSummaryTable();
                showLoading(false);
            });
        }

        // í•™ìƒë“¤ì˜ ì„ íƒ í˜„í™©ì„ Firestoreì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        async function fetchStudentSelections() {
            if (unsubscribeSelections) unsubscribeSelections();

            const date = menuDateInput.value;
            const mealType = mealTypeSelect.value;
            if (!date) return;

            const selectionsCollectionRef = collection(db, `artifacts/${appId}/public/data/studentSelections`);
            // Firestore ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • ë‚ ì§œì™€ ì‹ì‚¬ ìœ í˜•ì— í•´ë‹¹í•˜ëŠ” ì„ íƒë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
            // ë¬¸ì„œ IDê°€ 'date_mealType_studentId' í˜•ì‹ì´ë¯€ë¡œ startsWithë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            // ì´ëŠ” Firestoreì—ì„œ ì§ì ‘ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ëª¨ë“  ë¬¸ì„œë¥¼ ê°€ì ¸ì™€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•„í„°ë§í•˜ê±°ë‚˜
            // ë°ì´í„° ëª¨ë¸ì„ ë³€ê²½í•˜ì—¬ (ì˜ˆ: date, mealType í•„ë“œ ì¶”ê°€) ì¿¼ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.
            // ì—¬ê¸°ì„œëŠ” ì„¤ëª…ì„ ìœ„í•´ ëª¨ë“  ë¬¸ì„œë¥¼ ê°€ì ¸ì™€ í•„í„°ë§í•©ë‹ˆë‹¤. (ë°ì´í„°ê°€ ë§ì•„ì§€ë©´ ë¹„íš¨ìœ¨ì )
            // ë” ë‚˜ì€ ë°©ë²•: dateì™€ mealTypeì„ ë¬¸ì„œì˜ í•„ë“œë¡œ ì €ì¥í•˜ê³  í•´ë‹¹ í•„ë“œë¡œ ì¿¼ë¦¬.
            // ì˜ˆ: query(selectionsCollectionRef, where("date", "==", date), where("mealType", "==", mealType))
            // ì—¬ê¸°ì„œëŠ” ë¬¸ì„œ IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•„í„°ë§í•˜ëŠ” ë¡œì§ì„ ìœ ì§€í•©ë‹ˆë‹¤.

            showLoading(true);
            const q = query(collection(db, `artifacts/${appId}/public/data/studentSelections`));


            unsubscribeSelections = onSnapshot(q, (querySnapshot) => {
                studentSelections = {};
                querySnapshot.forEach((docSnap) => {
                    const docId = docSnap.id;
                    const parts = docId.split('_'); // YYYY-MM-DD_mealType_studentId
                    if (parts.length === 3 && parts[0] === date && parts[1] === mealType) {
                        const studentId = parseInt(parts[2]);
                        studentSelections[studentId] = docSnap.data().menu;
                    }
                });
                renderStudentTable(); // ì„ íƒ í˜„í™© ë³€ê²½ ì‹œ í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
                updateSummaryTable();
                showLoading(false);
            }, (error) => {
                console.error("Error fetching student selections: ", error);
                messageBox.innerHTML = 'í•™ìƒ ì„ íƒ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                studentSelections = {};
                renderStudentTable();
                updateSummaryTable();
                showLoading(false);
            });
        }


        // í•™ìƒ í…Œì´ë¸”ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
        function renderStudentTable() {
            studentTableBody.innerHTML = ''; 
            const date = menuDateInput.value;
            const mealType = mealTypeSelect.value;

            students.forEach((student, index) => {
                const row = document.createElement('tr');
                row.classList.add('table-row');
                row.dataset.studentId = student.id; 
                row.dataset.rowIndex = index;

                const studentSelectedMenu = studentSelections[student.id] || '';

                row.innerHTML = `
                    <td class="table-cell">${student.id}</td>
                    <td class="table-cell">${student.grade}</td>
                    <td class="table-cell">${student.name}</td>
                    <td class="table-cell menu-cell">${studentSelectedMenu || 'ì„ íƒ ì•ˆ í•¨'}</td>
                `;
                studentTableBody.appendChild(row);
            });

            if (selectedStudentRow) { // ì´ì „ì— ì„ íƒëœ í–‰ì´ ìˆë‹¤ë©´ ìŠ¤íƒ€ì¼ ë‹¤ì‹œ ì ìš©
                const prevSelectedStudentId = selectedStudentRow.dataset.studentId;
                const newSelectedRow = studentTableBody.querySelector(`[data-student-id="${prevSelectedStudentId}"]`);
                if (newSelectedRow) {
                    newSelectedRow.classList.add('selected');
                    selectedStudentRow = newSelectedRow; 
                } else {
                    selectedStudentRow = null;
                }
            }
        }

        // íŠ¹ì • í–‰ì— ëŒ€í•œ ë©”ë‰´ ì„ íƒ ë“œë¡­ë‹¤ìš´ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
        function renderMenuSelectionDropdown(studentId) {
            const row = studentTableBody.querySelector(`[data-student-id="${studentId}"]`);
            if (!row) return;

            const menuCell = row.querySelector('.menu-cell');
            const studentSelectedMenu = studentSelections[studentId] || '';

            const selectElement = document.createElement('select');
            selectElement.classList.add('p-1', 'border', 'rounded', 'w-full', 'text-sm', 'sm:text-base');

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'ë©”ë‰´ ì„ íƒ';
            selectElement.appendChild(defaultOption);

            currentMenus.forEach(menu => {
                const option = document.createElement('option');
                option.value = menu;
                option.textContent = menu;
                if (menu === studentSelectedMenu) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });

            selectElement.addEventListener('change', async (event) => {
                const newMenu = event.target.value;
                const date = menuDateInput.value;
                const mealType = mealTypeSelect.value;
                const selectionDocRef = doc(db, getStudentSelectionDocPath(date, mealType, studentId));
                
                showLoading(true);
                try {
                    if (newMenu) { // ë©”ë‰´ë¥¼ ì„ íƒí•œ ê²½ìš°
                        await setDoc(selectionDocRef, { menu: newMenu, studentName: students.find(s => s.id === studentId)?.name || 'ì•Œ ìˆ˜ ì—†ìŒ' });
                    } else { // "ë©”ë‰´ ì„ íƒ" (ë¹ˆ ê°’)ì„ ì„ íƒí•œ ê²½ìš°, ë¬¸ì„œ ì‚­ì œ
                        await deleteDoc(selectionDocRef);
                    }
                    // onSnapshotì´ ìë™ìœ¼ë¡œ í…Œì´ë¸”ì„ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë³„ë„ í˜¸ì¶œ ì•ˆ í•¨
                    messageBox.innerHTML = `${students.find(s=>s.id === studentId).name} í•™ìƒì˜ ë©”ë‰´ê°€ '${newMenu || 'ì„ íƒ ì•ˆ í•¨'}'ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                } catch (error) {
                    console.error("Error saving student selection: ", error);
                    messageBox.innerHTML = 'ë©”ë‰´ ì„ íƒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                } finally {
                    showLoading(false);
                }
            });

            menuCell.innerHTML = '';
            menuCell.appendChild(selectElement);
            selectElement.focus();
        }

        // ë©”ë‰´ ìš”ì•½ í…Œì´ë¸”ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
        function updateSummaryTable() {
            menuSummaryTableBody.innerHTML = '';
            const menuCounts = {};

            currentMenus.forEach(menu => {
                menuCounts[menu] = 0;
            });

            Object.values(studentSelections).forEach(selectedMenu => {
                if (selectedMenu && menuCounts.hasOwnProperty(selectedMenu)) {
                    menuCounts[selectedMenu]++;
                }
            });

            if (currentMenus.length > 0) {
                menuSummaryTableContainer.classList.remove('hidden');
                for (const menu in menuCounts) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${menu}</td>
                        <td>${menuCounts[menu]}ëª…</td>
                    `;
                    menuSummaryTableBody.appendChild(row);
                }
            } else {
                menuSummaryTableContainer.classList.add('hidden');
            }
        }

        // ë©”ì¸ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
        function updateMainTitle() {
            const date = menuDateInput.value;
            const mealTypeText = mealTypeSelect.options[mealTypeSelect.selectedIndex].text;
            if (date) {
                const dateObj = new Date(date);
                const month = dateObj.getMonth() + 1;
                const day = dateObj.getDate();
                mainTitle.textContent = `${month}ì›” ${day}ì¼ ${mealTypeText} ì‹ë‹¨`;
            } else {
                mainTitle.textContent = 'ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.';
            }
        }
        
        // ë‚ ì§œ/ì‹ì‚¬ ì‹œê°„ ë³€ê²½ ì‹œ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        function handleDateOrMealChange() {
            updateMainTitle();
            if (menuDateInput.value) {
                 fetchMenus(); // ë©”ë‰´ ë¡œë“œ (ë‚´ë¶€ì—ì„œ selectionsë„ ë¡œë“œ íŠ¸ë¦¬ê±° ê°€ëŠ¥)
                 fetchStudentSelections(); // í•™ìƒ ì„ íƒ í˜„í™© ë¡œë“œ
            } else {
                currentMenus = [];
                studentSelections = {};
                renderStudentTable();
                updateSummaryTable();
                messageBox.innerHTML = 'ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
            }
        }

        // ê´€ë¦¬ì ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
        adminLoginBtn.addEventListener('click', () => {
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                adminSection.classList.remove('locked');
                messageBox.innerHTML = 'ë©”ë‰´ ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ! ì´ì œ ì˜¤ëŠ˜ì˜ ë©”ë‰´ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                adminPasswordInput.value = ''; 
            } else {
                messageBox.innerHTML = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
            }
        });

        // "ë©”ë‰´ ì„¤ì •" ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        setTodayMenusBtn.addEventListener('click', async () => {
            const date = menuDateInput.value;
            const mealType = mealTypeSelect.value;

            if (!date) {
                messageBox.innerHTML = 'ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.';
                return;
            }

            const newMenus = menuInputs.map(input => input.value.trim()).filter(menu => menu !== '');

            if (newMenus.length === 0) {
                messageBox.innerHTML = 'ìµœì†Œ í•œ ê°€ì§€ ì´ìƒì˜ ë©”ë‰´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }
            
            showLoading(true);
            const menuDocRef = doc(db, getMenuDocPath(date, mealType));
            try {
                await setDoc(menuDocRef, { items: newMenus });
                messageBox.innerHTML = `ì„ íƒëœ ë‚ ì§œì™€ ì‹ì‚¬ ì‹œê°„ëŒ€ì˜ ë©”ë‰´ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                menuInputs.forEach(input => input.value = ''); // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”

                // ë©”ë‰´ ë³€ê²½ ì‹œ, í•´ë‹¹ ë‚ ì§œ/ì‹ì‚¬ ì‹œê°„ëŒ€ì˜ ê¸°ì¡´ í•™ìƒ ì„ íƒì„ ì´ˆê¸°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì„ íƒ ì‚¬í•­)
                // ì—¬ê¸°ì„œëŠ” onSnapshotì´ ìë™ìœ¼ë¡œ UIë¥¼ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ ë³„ë„ UI ê°±ì‹  í˜¸ì¶œì€ ìµœì†Œí™”í•©ë‹ˆë‹¤.
                // ë§Œì•½ ê¸°ì¡´ ì„ íƒì„ ëª¨ë‘ ì§€ìš°ë ¤ë©´, ê´€ë ¨ studentSelections ë¬¸ì„œë“¤ì„ ì‚­ì œí•´ì•¼ í•©ë‹ˆë‹¤.
                // ì˜ˆ: clearStudentSelectionsForMenu(date, mealType);

            } catch (error) {
                console.error("Error setting menus: ", error);
                messageBox.innerHTML = 'ë©”ë‰´ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            } finally {
                showLoading(false);
            }
        });

        // ë‚ ì§œ ë˜ëŠ” ì‹ì‚¬ ì‹œê°„ëŒ€ ë³€ê²½ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        menuDateInput.addEventListener('change', handleDateOrMealChange);
        mealTypeSelect.addEventListener('change', handleDateOrMealChange);

        // í…Œì´ë¸” í–‰ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì„ íƒ ë° ë©”ë‰´ ë“œë¡­ë‹¤ìš´)
        studentTableBody.addEventListener('click', (event) => {
            let row = event.target.closest('tr');
            if (row && row.parentNode === studentTableBody) { // í…Œì´ë¸” ë°”ë”” ë‚´ì˜ í–‰ì¸ì§€ í™•ì¸
                if (selectedStudentRow) {
                    selectedStudentRow.classList.remove('selected');
                    // ì´ì „ ë“œë¡­ë‹¤ìš´ì„ í…ìŠ¤íŠ¸ë¡œ ë˜ëŒë¦´ í•„ìš”ê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬ (í˜„ì¬ëŠ” onSnapshotìœ¼ë¡œ ì „ì²´ ê°±ì‹ )
                    const prevMenuCell = selectedStudentRow.querySelector('.menu-cell');
                    if (prevMenuCell) { // ì´ì „ ì„ íƒëœ í–‰ì˜ ë©”ë‰´ ì…€ì„ ì›ë˜ëŒ€ë¡œ ë³µì›
                         const prevStudentId = parseInt(selectedStudentRow.dataset.studentId);
                         prevMenuCell.textContent = studentSelections[prevStudentId] || 'ì„ íƒ ì•ˆ í•¨';
                    }
                }
                selectedStudentRow = row;
                selectedStudentRow.classList.add('selected');

                const studentId = parseInt(row.dataset.studentId);
                const studentName = students.find(s => s.id === studentId)?.name || 'í•´ë‹¹ í•™ìƒ';
                
                if (currentMenus.length > 0) {
                    renderMenuSelectionDropdown(studentId);
                    messageBox.innerHTML = `<strong>${studentName}</strong> í•™ìƒì˜ ë©”ë‰´ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ë³€ê²½í•´ ì£¼ì„¸ìš”.`;
                } else {
                    messageBox.innerHTML = `<strong>${studentName}</strong> í•™ìƒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë¨¼ì € ê´€ë¦¬ìê°€ í•´ë‹¹ ë‚ ì§œì™€ ì‹ì‚¬ ì‹œê°„ëŒ€ì˜ ë©”ë‰´ë¥¼ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.`;
                }
            }
        });
        
        // ìµëª…ìœ¼ë¡œ Firebaseì— ë¡œê·¸ì¸
        async function signInUserAnonymously() {
            try {
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid;
                console.log("Signed in anonymously with UID:", userId);
                // ë¡œê·¸ì¸ ì„±ê³µ í›„ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
                initializePage();
            } catch (error) {
                console.error("Anonymous sign-in failed:", error);
                messageBox.textContent = "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.";
                showLoading(false);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì„¤ì •
        function initializePage() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            if (!menuDateInput.value) { // ì‚¬ìš©ìê°€ ì´ë¯¸ ë‚ ì§œë¥¼ ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
                 menuDateInput.value = `${year}-${month}-${day}`;
            }
            
            handleDateOrMealChange(); // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        }

        // Firebase Auth ìƒíƒœ ë³€ê²½ ê°ì§€
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì–´ ìˆìŒ (ìµëª… í¬í•¨)
                userId = user.uid;
                console.log("User is signed in with UID:", userId);
                if (firebaseConfig.apiKey !== "YOUR_API_KEY") { // Firebase ì„¤ì •ì´ ë˜ì—ˆì„ ë•Œë§Œ í˜ì´ì§€ ì´ˆê¸°í™”
                    initializePage();
                } else {
                    messageBox.innerHTML = "<strong>ê²½ê³ :</strong> Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ì½”ë“œ ë‚´ <code>firebaseConfig</code>ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.";
                    showLoading(false);
                }
            } else {
                // ì‚¬ìš©ìê°€ ë¡œê·¸ì•„ì›ƒí–ˆê±°ë‚˜ ì•„ì§ ë¡œê·¸ì¸í•˜ì§€ ì•ŠìŒ
                console.log("User is signed out. Attempting anonymous sign-in.");
                if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                     signInUserAnonymously();
                } else {
                    messageBox.innerHTML = "<strong>ê²½ê³ :</strong> Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ì½”ë“œ ë‚´ <code>firebaseConfig</code>ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.";
                    showLoading(false);
                }
            }
        });

    </script>
</body>
</html>
